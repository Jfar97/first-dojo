#!/usr/local/bin/python

import os
import random
import string
import subprocess

DIR = os.path.dirname(os.path.abspath(__file__))
challenge_num = random.randint(0, 2)
CHALLENGES_DIR = os.path.join(DIR, "challenge_files")
C_FILE = os.path.join(CHALLENGES_DIR, f"{challenge_num}.c")
OUT_BIN = os.path.join(DIR, "challenge")
EXPECTEDKEY = os.path.join(DIR, "expected_key")
VERSION = os.path.join(DIR, "version")
ERRLOG = os.path.join(DIR, "init_error.log")
GCC = "/run/dojo/bin/gcc"

def rand_word(min_len, max_len):
    alphabet = string.ascii_lowercase
    L = random.randint(min_len, max_len)
    return "".join(random.choice(alphabet) for _ in range(L))

def define_arg(name, value):
    # gcc should receive something like: -DS1="abcdef"
    return '-D%s="%s"' % (name, value)

def main():
    # Generate S1..S15 explicitly (no comprehensions, no f-strings)
    s1  = rand_word(6, 12)
    s2  = rand_word(6, 12)
    s3  = rand_word(6, 12)
    s4  = rand_word(6, 12)
    s5  = rand_word(6, 12)
    s6  = rand_word(6, 12)
    s7  = rand_word(6, 12)
    s8  = rand_word(6, 12)
    s9  = rand_word(6, 12)
    s10 = rand_word(6, 12)
    s11 = rand_word(6, 12)
    s12 = rand_word(6, 12)
    s13 = rand_word(6, 12)
    s14 = rand_word(6, 12)
    s15 = rand_word(6, 12)

    cmd = [
        GCC,
        "-g", "-O0", "-Wall", "-Wextra",
        define_arg("S1", s1),
        define_arg("S2", s2),
        define_arg("S3", s3),
        define_arg("S4", s4),
        define_arg("S5", s5),
        define_arg("S6", s6),
        define_arg("S7", s7),
        define_arg("S8", s8),
        define_arg("S9", s9),
        define_arg("S10", s10),
        define_arg("S11", s11),
        define_arg("S12", s12),
        define_arg("S13", s13),
        define_arg("S14", s14),
        define_arg("S15", s15),
        "-o", OUT_BIN,
        C_FILE,
    ]

    try:
        subprocess.check_call(cmd)
    except Exception as e:
        try:
            f = open(ERRLOG, "w")
            f.write("C_FILE exists: %r\n" % os.path.exists(C_FILE))
            f.write("cmd: %r\n" % cmd)
            f.write("error: %r\n" % e)
            f.close()
        except Exception:
            pass
        raise

    match challenge_num:
        case 0:
            # var1 + var2 + var3 + var4 + var5 + var6 + var7 + var8 + var9
            expected_key = s1 + s2 + s3 + s4 + s5 + s6 + s7 + s8 + s9
            f = open(VERSION, "w")
            f.write("0" + "\n")
            f.close()
        case 1:
            # var3 + var6 + var1 + var2 + var13 + var1 + var2 + var9 + var4 + var5 + var10
            expected_key = s3 + s6 + s1 + s2 + s13 + s1 + s2 + s9 + s4 + s5 + s10
            f = open(VERSION, "w")
            f.write("1" + "\n")
            f.close()
        case 2:
            # var11 + var13 + var9 + var10 + var4 + var12 + var6 + var4 + var12 + var2 + var1 
            expected_key = s11 + s13 + s9 + s10 + s4 + s12 + s6 + s4 + s12 + s2 + s1
            f = open(VERSION, "w")
            f.write("2" + "\n")
            f.close()

    f = open(EXPECTEDKEY, "w")
    f.write(expected_key + "\n")
    f.close()

    try:
        os.chmod(OUT_BIN, 0o755)
    except Exception:
        pass

if __name__ == "__main__":
    main()
